#!/bin/bash
#
# HACKINTOSHSTER-PROXMOX: Modern macOS VM Deployment System
# Automated deployment of macOS 15+ (Sequoia/Tahoe) virtual machines on Proxmox VE
# Optimized for modern macOS with VirtIO drivers, Skylake-Client-v4 CPU emulation,
# OpenCore bootloader, and comprehensive hardware compatibility.
#
# Author: Mario Aldayuz (thenotoriousllama)
# GitHub: https://github.com/marioaldayuz/PROXMOX-macOS
# Website: https://hackintoshster.com
#
# COPYRIGHT - 2024-2026
#
# Supports: macOS Sequoia (15) and macOS Tahoe (26)
# Platform: Proxmox VE 7.x, 8.x, 9.x (Intel and AMD processors)
# Features: VirtIO networking/storage, automated recovery image creation,
#           network bridge provisioning, SMBIOS customization, DHCP server
#
################################################################################################################################################################################################

# Terminate script execution immediately if any command returns non-zero exit status
set -e

# Detect script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export SCRIPT_DIR

# Source all library modules
source "${SCRIPT_DIR}/scripts/lib/config.sh"
source "${SCRIPT_DIR}/scripts/lib/logging.sh"
source "${SCRIPT_DIR}/scripts/lib/validation.sh"
source "${SCRIPT_DIR}/scripts/lib/math-utils.sh"

# Source system management modules
source "${SCRIPT_DIR}/scripts/system/check-prerequisites.sh"
source "${SCRIPT_DIR}/scripts/system/setup-prerequisites.sh"

# Source storage and dependency modules
source "${SCRIPT_DIR}/scripts/storage/storage-manager.sh"
source "${SCRIPT_DIR}/scripts/dependencies/dependency-installer.sh"

# Source network module
source "${SCRIPT_DIR}/scripts/network/bridge-manager.sh"

# Source SMBIOS module
source "${SCRIPT_DIR}/scripts/smbios/smbios-manager.sh"

# Source OpenCore module
source "${SCRIPT_DIR}/scripts/opencore/opencore-manager.sh"

# Source recovery module
source "${SCRIPT_DIR}/scripts/recovery/recovery-manager.sh"

# Source VM modules
source "${SCRIPT_DIR}/scripts/vm/vm-creator.sh"
source "${SCRIPT_DIR}/scripts/vm/vm-configurator.sh"

# Source utilities module
source "${SCRIPT_DIR}/scripts/utilities/system-utilities.sh"

# Source UI module
source "${SCRIPT_DIR}/scripts/ui/menu-handler.sh"

# Automatic resource cleanup handler that executes on script exit (success or failure)
# Safely unmounts any active loop devices and removes temporary files to prevent resource leaks
# Registered via trap to ensure cleanup occurs even during abnormal termination
cleanup() {
  local logfile="${LOGDIR}/cleanup.log"
  # Unmount Apple recovery image mount point if currently mounted
  if mountpoint -q /mnt/APPLE 2>/dev/null; then
    umount /mnt/APPLE >>"$logfile" 2>&1 || display_and_log "Failed to unmount /mnt/APPLE" "$logfile"
    rmdir /mnt/APPLE 2>/dev/null
  fi
  # Unmount OpenCore ISO mount point if currently mounted
  if mountpoint -q /mnt/opencore 2>/dev/null; then
    umount /mnt/opencore >>"$logfile" 2>&1 || display_and_log "Failed to unmount /mnt/opencore" "$logfile"
    rmdir /mnt/opencore 2>/dev/null
  fi
  # Detach any loop devices associated with temporary directory files
  losetup -a | grep -q "$TMPDIR" && losetup -d $(losetup -j "$TMPDIR"/* | awk -F: '{print $1}') >>"$logfile" 2>&1
  # Purge all temporary files while protecting against accidental root deletion
  rm -rf "${TMPDIR:?}"/* 2>/dev/null
}
# Register cleanup function to execute automatically when script exits
trap cleanup EXIT

# Parse command-line arguments for non-interactive mode
INTERACTIVE_MODE=true
if [[ $# -gt 0 ]]; then
  INTERACTIVE_MODE=false
  
  # Parse arguments
  while [[ $# -gt 0 ]]; do
    case $1 in
      --version)
        CLI_VERSION="$2"
        shift 2
        ;;
      --vmid)
        CLI_VM_ID="$2"
        shift 2
        ;;
      --name)
        CLI_VM_NAME="$2"
        shift 2
        ;;
      --profile)
        CLI_PROFILE="$2"
        shift 2
        ;;
      --disk)
        CLI_DISK_SIZE="$2"
        shift 2
        ;;
      --storage)
        CLI_STORAGE="$2"
        shift 2
        ;;
      --bridge)
        CLI_BRIDGE="$2"
        shift 2
        ;;
      --cores)
        CLI_CORES="$2"
        shift 2
        ;;
      --ram)
        CLI_RAM="$2"
        shift 2
        ;;
      --download-recovery)
        CLI_DOWNLOAD_RECOVERY="yes"
        shift
        ;;
      --help|-h)
        echo "Usage: setup [OPTIONS]"
        echo ""
        echo "Interactive mode (no arguments): Launch menu-driven interface"
        echo ""
        echo "Non-interactive mode options:"
        echo "  --version <sequoia|tahoe>    macOS version to install"
        echo "  --vmid <id>                  VM ID (default: next available)"
        echo "  --name <name>                VM name (default: macOS-SEQUOIA or macOS-TAHOE)"
        echo ""
        echo "Configuration profiles (recommended):"
        echo "  --profile <profile>          Use predefined configuration"
        echo "                               Profiles: minimal, balanced, performance, maximum"
        echo ""
        echo "Or specify individual settings:"
        echo "  --disk <size>                Disk size in GB (default: 80)"
        echo "  --cores <count>              CPU cores - power of 2 (default: 4)"
        echo "  --ram <size>                 RAM in MiB (default: auto-calculate)"
        echo ""
        echo "Additional options:"
        echo "  --storage <storage>          Proxmox storage name (default: auto-detect)"
        echo "  --bridge <bridge>            Network bridge (default: vmbr0)"
        echo "  --download-recovery          Download recovery image from Apple"
        echo ""
        echo "Examples:"
        echo "  # Using a profile (recommended)"
        echo "  mac --version sequoia --profile balanced"
        echo ""
        echo "  # Custom configuration"
        echo "  mac --version sequoia --vmid 100 --name MyMac --disk 120 --cores 8"
        echo ""
        echo "  # Maximum performance with recovery download"
        echo "  mac --version tahoe --profile maximum --download-recovery"
        exit 0
        ;;
      *)
        echo "Unknown option: $1"
        echo "Use --help for usage information"
        exit 1
        ;;
    esac
  done
fi

################################################################################################################################################################################################
# SCRIPT ENTRY POINT - Initialization sequence and main loop
################################################################################################################################################################################################

clear
# Create log and temp directories before any operations
init_dirs
# Verify Proxmox version compatibility (7.x, 8.x, or 9.x)
check_proxmox_version
# Prompt for ISO storage selection and set global ISODIR variable
set_isodir
sleep 2
# Detect CPU platform (AMD vs Intel) for platform-specific configurations
export OSX_PLATFORM=$(detect_cpu_platform)

# Check if system has been initialized
if ! check_system_initialized; then
  exit 1
fi

# Enter main menu loop or run non-interactive mode
if [[ "$INTERACTIVE_MODE" == "true" ]]; then
  main_menu
else
  create_vm_noninteractive
fi

